<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Peer Feedback</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 980px; margin: 24px auto; padding: 0 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    input, select, textarea, button { width: 100%; padding: 10px; margin: 6px 0 12px; box-sizing: border-box; }
    textarea { min-height: 90px; }
    button { cursor: pointer; }
    .muted { color: #666; font-size: 13px; }
    .ok { color: #0a7; }
    .err { color: #c00; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; vertical-align: top; }
    th { background: #fafafa; }
    .pill { display: inline-block; padding: 2px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; }
    .split { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  </style>
</head>
<body>
  <h2>Peer Feedback (Simple PIN version)</h2>
  <p class="muted">Note: This version has no real security. Anyone with the link can access data.</p>

  <div class="card" id="loginCard">
    <h3>1) Login</h3>
    <div class="row">
      <div>
        <label>Your company email</label>
        <input id="email" placeholder="name@company.com" />
      </div>
      <div>
        <label>Your PIN</label>
        <input id="pin" type="password" placeholder="PIN" />
      </div>
    </div>
    <button id="loginBtn">Login</button>
    <button id="logoutBtn" style="display:none;">Logout</button>
    <div id="loginMsg" class="muted"></div>
  </div>

  <div class="card" id="submitCard" style="display:none;">
    <h3>2) Give feedback</h3>

    <label>Recipient (your allowed peers)</label>
    <select id="recipient"><option value="">Loading…</option></select>

    <label>Rating (1–5)</label>
    <select id="rating">
      <option value="">Select…</option>
      <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
    </select>

    <label>One strength</label>
    <textarea id="strength"></textarea>

    <label>One improvement</label>
    <textarea id="improve"></textarea>

    <button id="submitBtn">Submit</button>
    <div id="submitMsg" class="muted"></div>
  </div>

  <div class="card" id="mineCard" style="display:none;">
    <h3>3) My feedback (anonymous)</h3>
    <button id="refreshMine">Refresh</button>
    <div id="mine"></div>
  </div>

  <div class="card" id="adminCard">
    <h3>4) Admin (define peer mapping + view all)</h3>
    <p class="muted">Admin mode is unlocked using the admin PIN stored in Firestore: <span class="pill">config/admin.adminPin</span></p>

    <div class="row">
      <div>
        <label>Admin PIN</label>
        <input id="adminPin" type="password" placeholder="Admin PIN" />
      </div>
      <div style="display:flex;align-items:flex-end;">
        <button id="unlockAdminBtn">Unlock Admin</button>
      </div>
    </div>

    <div id="adminArea" style="display:none;">
      <div class="split">
        <div class="card">
          <h4>4A) Add peer mapping</h4>
          <label>Rater email</label>
          <input id="mapRater" placeholder="mehmet@company.com" />
          <label>Peer email</label>
          <input id="mapPeer" placeholder="tala@company.com" />
          <button id="addMapBtn">Add mapping</button>
          <div id="mapMsg" class="muted"></div>
        </div>

        <div class="card">
          <h4>4B) Create / update user PIN</h4>
          <label>User email</label>
          <input id="pinEmail" placeholder="mehmet@company.com" />
          <label>PIN</label>
          <input id="pinValue" placeholder="e.g. 1357" />
          <label>Active</label>
          <select id="pinActive">
            <option value="true">true</option>
            <option value="false">false</option>
          </select>
          <button id="savePinBtn">Save PIN</button>
          <div id="pinMsg" class="muted"></div>
        </div>
      </div>

      <div class="card">
        <h4>4C) HoD view (private feedback with rater)</h4>
        <button id="refreshAllBtn">Refresh All</button>
        <div id="all"></div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, doc, getDoc, setDoc,
    collection, query, where, getDocs,
    addDoc, serverTimestamp,
    orderBy, limit
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ====== PASTE YOUR FIREBASE CONFIG ======
const firebaseConfig = {
  apiKey: "AIzaSyCZxIgiXvpVIA10mbAfXdelZ2GAA8Zc5jQ",
  authDomain: "peer-feedback-4de63.firebaseapp.com",
  projectId: "peer-feedback-4de63",
  storageBucket: "peer-feedback-4de63.firebasestorage.app",
  messagingSenderId: "977480782634",
  appId: "1:977480782634:web:2bf3b786ca8ab3d8e4c453"
};

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const $ = (id) => document.getElementById(id);

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  }

  function normEmail(email) {
    return String(email || "").trim().toLowerCase();
  }

  function renderTable(rows, hodMode) {
    if (!rows || !rows.length) return `<p class="muted">No feedback found.</p>`;

    const head = hodMode
      ? `<tr><th>Time</th><th>Rater</th><th>Recipient</th><th>Rating</th><th>Strength</th><th>Improve</th></tr>`
      : `<tr><th>Time</th><th>Rating</th><th>Strength</th><th>Improve</th></tr>`;

    const body = rows.map(r => {
      const t = r.createdAt?.toDate ? r.createdAt.toDate().toLocaleString() : "";
      if (hodMode) {
        return `<tr>
          <td>${escapeHtml(t)}</td>
          <td><span class="pill">${escapeHtml(r.raterEmail)}</span></td>
          <td><span class="pill">${escapeHtml(r.recipientEmail)}</span></td>
          <td>${escapeHtml(r.rating)}</td>
          <td>${escapeHtml(r.strength)}</td>
          <td>${escapeHtml(r.improve)}</td>
        </tr>`;
      }
      return `<tr>
        <td>${escapeHtml(t)}</td>
        <td>${escapeHtml(r.rating)}</td>
        <td>${escapeHtml(r.strength)}</td>
        <td>${escapeHtml(r.improve)}</td>
      </tr>`;
    }).join("");

    return `<table>${head}${body}</table>`;
  }

  // ====== SESSION (client-side only) ======
  function setSession(email) {
    localStorage.setItem("pf_email", email);
  }
  function getSessionEmail() {
    return localStorage.getItem("pf_email");
  }
  function clearSession() {
    localStorage.removeItem("pf_email");
  }

  function setLoggedInUI(on) {
    $("logoutBtn").style.display = on ? "" : "none";
    $("submitCard").style.display = on ? "" : "none";
    $("mineCard").style.display = on ? "" : "none";
  }

  // ====== PIN CHECK (client-side) ======
  async function checkPin(email, pin) {
    const ref = doc(db, "pins", email);
    const snap = await getDoc(ref);
    if (!snap.exists()) return { ok: false, error: "No PIN set for this email." };

    const data = snap.data();
    if (!data.active) return { ok: false, error: "Account is disabled." };

    if (String(data.pin || "") !== String(pin || "")) {
      return { ok: false, error: "Invalid PIN." };
    }
    return { ok: true };
  }

  async function loadPeers(myEmail) {
    const q = query(collection(db, "peerMap"), where("raterEmail", "==", myEmail));
    const snap = await getDocs(q);
    const peers = snap.docs.map(d => d.data().peerEmail);

    const sel = $("recipient");
    if (!peers.length) {
      sel.innerHTML = `<option value="">No peers assigned</option>`;
      return;
    }
    sel.innerHTML = `<option value="">Select…</option>` +
      peers.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
  }

  async function submitFeedback(myEmail) {
    const recipientEmail = normEmail($("recipient").value);
    const rating = parseInt($("rating").value, 10);
    const strength = $("strength").value.trim();
    const improve = $("improve").value.trim();

    if (!recipientEmail) throw new Error("Select a recipient.");
    if (!rating || rating < 1 || rating > 5) throw new Error("Select a rating 1–5.");
    if (!strength || !improve) throw new Error("Strength and improvement are required.");
    if (recipientEmail === myEmail) throw new Error("You cannot rate yourself.");

    // (Optional) client-side check mapping exists (not security, just UX)
    const mapId = `${myEmail}__${recipientEmail}`;
    const mapSnap = await getDoc(doc(db, "peerMap", mapId));
    if (!mapSnap.exists()) throw new Error("Not allowed to rate this peer (mapping missing).");

    await addDoc(collection(db, "feedback_public"), {
      recipientEmail,
      rating,
      strength,
      improve,
      createdAt: serverTimestamp()
    });

    await addDoc(collection(db, "feedback_private"), {
      raterEmail: myEmail,
      recipientEmail,
      rating,
      strength,
      improve,
      createdAt: serverTimestamp()
    });
  }

  async function loadMyFeedback(myEmail) {
    const q = query(
      collection(db, "feedback_public"),
      where("recipientEmail", "==", myEmail),
      orderBy("createdAt", "desc"),
      limit(50)
    );
    const snap = await getDocs(q);
    $("mine").innerHTML = renderTable(snap.docs.map(d => d.data()), false);
  }

  async function loadAllPrivate() {
    const q = query(collection(db, "feedback_private"), orderBy("createdAt", "desc"), limit(200));
    const snap = await getDocs(q);
    $("all").innerHTML = renderTable(snap.docs.map(d => d.data()), true);
  }

  // ====== LOGIN ======
  $("loginBtn").addEventListener("click", async () => {
    $("loginMsg").textContent = "";
    try {
      const email = normEmail($("email").value);
      const pin = $("pin").value.trim();
      if (!email || !pin) throw new Error("Enter email and PIN.");

      const res = await checkPin(email, pin);
      if (!res.ok) throw new Error(res.error);

      setSession(email);
      setLoggedInUI(true);
      $("loginMsg").innerHTML = `<span class="ok">Logged in:</span> ${escapeHtml(email)}`;

      await loadPeers(email);
      await loadMyFeedback(email);

    } catch (e) {
      $("loginMsg").innerHTML = `<span class="err">${escapeHtml(e.message)}</span>`;
    }
  });

  $("logoutBtn").addEventListener("click", () => {
    clearSession();
    setLoggedInUI(false);
    $("loginMsg").textContent = "Logged out.";
  });

  $("submitBtn").addEventListener("click", async () => {
    $("submitMsg").textContent = "";
    try {
      const email = getSessionEmail();
      if (!email) throw new Error("Login first.");

      await submitFeedback(email);
      $("submitMsg").innerHTML = `<span class="ok">Submitted.</span>`;
      $("rating").value = "";
      $("strength").value = "";
      $("improve").value = "";

      await loadMyFeedback(email);
    } catch (e) {
      $("submitMsg").innerHTML = `<span class="err">${escapeHtml(e.message)}</span>`;
    }
  });

  $("refreshMine").addEventListener("click", async () => {
    const email = getSessionEmail();
    if (!email) return;
    await loadMyFeedback(email);
  });

  // ====== ADMIN UNLOCK (client-side) ======
  $("unlockAdminBtn").addEventListener("click", async () => {
    try {
      const entered = $("adminPin").value.trim();
      const snap = await getDoc(doc(db, "config", "admin"));
      if (!snap.exists()) throw new Error("Missing config/admin doc.");

      const adminPin = String(snap.data().adminPin || "");
      if (entered !== adminPin) throw new Error("Wrong admin PIN.");

      $("adminArea").style.display = "";
      $("unlockAdminBtn").disabled = true;
      $("adminPin").disabled = true;
    } catch (e) {
      alert(e.message);
    }
  });

  $("addMapBtn").addEventListener("click", async () => {
    $("mapMsg").textContent = "";
    try {
      const raterEmail = normEmail($("mapRater").value);
      const peerEmail = normEmail($("mapPeer").value);
      if (!raterEmail || !peerEmail) throw new Error("Enter both emails.");

      const id = `${raterEmail}__${peerEmail}`;
      await setDoc(doc(db, "peerMap", id), { raterEmail, peerEmail });

      $("mapMsg").innerHTML = `<span class="ok">Mapping saved:</span> ${escapeHtml(id)}`;
    } catch (e) {
      $("mapMsg").innerHTML = `<span class="err">${escapeHtml(e.message)}</span>`;
    }
  });

  $("savePinBtn").addEventListener("click", async () => {
    $("pinMsg").textContent = "";
    try {
      const email = normEmail($("pinEmail").value);
      const pin = $("pinValue").value.trim();
      const active = $("pinActive").value === "true";
      if (!email || !pin) throw new Error("Enter email and PIN.");

      await setDoc(doc(db, "pins", email), { pin, active });
      $("pinMsg").innerHTML = `<span class="ok">PIN saved for:</span> ${escapeHtml(email)}`;
    } catch (e) {
      $("pinMsg").innerHTML = `<span class="err">${escapeHtml(e.message)}</span>`;
    }
  });

  $("refreshAllBtn").addEventListener("click", loadAllPrivate);

  // ====== AUTO RESTORE SESSION ======
  (async function init() {
    const email = getSessionEmail();
    if (email) {
      setLoggedInUI(true);
      $("loginMsg").innerHTML = `<span class="ok">Logged in:</span> ${escapeHtml(email)}`;
      await loadPeers(email);
      await loadMyFeedback(email);
    } else {
      setLoggedInUI(false);
      $("loginMsg").textContent = "Not logged in.";
    }
  })();
</script>
</body>
</html>

