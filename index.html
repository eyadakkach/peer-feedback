<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Peer Feedback</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: 24px auto; padding: 0 12px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; margin: 12px 0; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    input, select, textarea, button { width: 100%; padding: 10px; margin: 6px 0 12px; box-sizing: border-box; }
    textarea { min-height: 90px; }
    button { cursor: pointer; }
    .muted { color: #666; font-size: 13px; }
    .ok { color: #0a7; }
    .err { color: #c00; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid #eee; padding: 10px; text-align: left; vertical-align: top; }
    th { background: #fafafa; }
    .pill { display: inline-block; padding: 2px 8px; border: 1px solid #ddd; border-radius: 999px; font-size: 12px; }
  </style>
</head>
<body>
  <h2>Peer Feedback</h2>
  <p class="muted">Sign in with your company email (magic link). Recipients do not see rater names.</p>

  <div class="card" id="authCard">
    <h3>1) Sign in</h3>
    <label>Company email</label>
    <input id="email" placeholder="name@company.com" />
    <button id="sendLinkBtn">Send sign-in link</button>

    <div class="muted">
      <div id="authMsg"></div>
      <div id="signedInMsg"></div>
    </div>

    <button id="logoutBtn" style="display:none;">Sign out</button>
  </div>

  <div class="card" id="submitCard" style="display:none;">
    <h3>2) Give feedback</h3>

    <label>Recipient (your allowed peers)</label>
    <select id="recipient"><option value="">Loading…</option></select>

    <label>Rating (1–5)</label>
    <select id="rating">
      <option value="">Select…</option>
      <option>1</option><option>2</option><option>3</option><option>4</option><option>5</option>
    </select>

    <label>One strength</label>
    <textarea id="strength"></textarea>

    <label>One improvement</label>
    <textarea id="improve"></textarea>

    <button id="submitBtn">Submit</button>
    <div id="submitMsg" class="muted"></div>
  </div>

  <div class="card" id="mineCard" style="display:none;">
    <h3>3) My feedback (anonymous)</h3>
    <button id="refreshMine">Refresh</button>
    <div id="mine"></div>
  </div>

  <div class="card" id="hodCard" style="display:none;">
    <h3>4) HoD dashboard</h3>
    <button id="refreshHod">Refresh</button>
    <div id="hod"></div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth,
    sendSignInLinkToEmail,
    isSignInWithEmailLink,
    signInWithEmailLink,
    onAuthStateChanged,
    signOut
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore,
    doc, getDoc, setDoc,
    collection, query, where, getDocs,
    addDoc, serverTimestamp,
    orderBy, limit
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // ====== CONFIG ======
  const COMPANY_DOMAIN = "company.com"; // <-- change to your domain

  const firebaseConfig = {
    apiKey: "PASTE_ME",
    authDomain: "PASTE_ME",
    projectId: "PASTE_ME",
    storageBucket: "PASTE_ME",
    messagingSenderId: "PASTE_ME",
    appId: "PASTE_ME"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const $ = (id) => document.getElementById(id);

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  }

  function normEmail(email) {
    return String(email || "").trim().toLowerCase();
  }

  function setUI(signedIn, isHod = false) {
    $("submitCard").style.display = signedIn ? "" : "none";
    $("mineCard").style.display = signedIn ? "" : "none";
    $("logoutBtn").style.display = signedIn ? "" : "none";
    $("hodCard").style.display = (signedIn && isHod) ? "" : "none";
  }

  async function ensureUserDoc(user) {
    const email = normEmail(user.email);
    const ref = doc(db, "users", user.uid);
    const snap = await getDoc(ref);

    // First login: create as employee
    if (!snap.exists()) {
      await setDoc(ref, {
        email,
        name: user.email || "Unknown",
        role: "employee"
      });
      return { email, role: "employee" };
    }

    return snap.data();
  }

  async function loadPeersForMe(myEmail) {
    const q = query(collection(db, "peerMap"), where("raterEmail", "==", myEmail));
    const snap = await getDocs(q);
    const peers = snap.docs.map(d => d.data().peerEmail);

    const sel = $("recipient");
    if (!peers.length) {
      sel.innerHTML = `<option value="">No peers assigned</option>`;
      return;
    }

    sel.innerHTML = `<option value="">Select…</option>` +
      peers.map(p => `<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join("");
  }

  async function submitFeedback(myEmail) {
    $("submitMsg").textContent = "";
    const recipientEmail = normEmail($("recipient").value);
    const rating = parseInt($("rating").value, 10);
    const strength = $("strength").value.trim();
    const improve = $("improve").value.trim();

    if (!recipientEmail) throw new Error("Select a recipient.");
    if (!rating || rating < 1 || rating > 5) throw new Error("Select a rating 1–5.");
    if (!strength || !improve) throw new Error("Strength and improvement are required.");
    if (recipientEmail === myEmail) throw new Error("You cannot rate yourself.");

    await addDoc(collection(db, "feedback_public"), {
      recipientEmail,
      rating,
      strength,
      improve,
      createdAt: serverTimestamp()
    });

    await addDoc(collection(db, "feedback_private"), {
      raterEmail: myEmail,
      recipientEmail,
      rating,
      strength,
      improve,
      createdAt: serverTimestamp()
    });
  }

  function renderTable(rows, hodMode) {
    if (!rows.length) return `<p class="muted">No feedback found.</p>`;

    const head = hodMode
      ? `<tr><th>Time</th><th>Rater</th><th>Recipient</th><th>Rating</th><th>Strength</th><th>Improve</th></tr>`
      : `<tr><th>Time</th><th>Rating</th><th>Strength</th><th>Improve</th></tr>`;

    const body = rows.map(r => {
      const t = r.createdAt?.toDate ? r.createdAt.toDate().toLocaleString() : "";
      if (hodMode) {
        return `<tr>
          <td>${escapeHtml(t)}</td>
          <td><span class="pill">${escapeHtml(r.raterEmail)}</span></td>
          <td><span class="pill">${escapeHtml(r.recipientEmail)}</span></td>
          <td>${escapeHtml(r.rating)}</td>
          <td>${escapeHtml(r.strength)}</td>
          <td>${escapeHtml(r.improve)}</td>
        </tr>`;
      }
      return `<tr>
        <td>${escapeHtml(t)}</td>
        <td>${escapeHtml(r.rating)}</td>
        <td>${escapeHtml(r.strength)}</td>
        <td>${escapeHtml(r.improve)}</td>
      </tr>`;
    }).join("");

    return `<table>${head}${body}</table>`;
  }

  async function loadMyFeedback(myEmail) {
    const q = query(
      collection(db, "feedback_public"),
      where("recipientEmail", "==", myEmail),
      orderBy("createdAt", "desc"),
      limit(50)
    );
    const snap = await getDocs(q);
    $("mine").innerHTML = renderTable(snap.docs.map(d => d.data()), false);
  }

  async function loadHodFeedback() {
    const q = query(collection(db, "feedback_private"), orderBy("createdAt", "desc"), limit(200));
    const snap = await getDocs(q);
    $("hod").innerHTML = renderTable(snap.docs.map(d => d.data()), true);
  }

  // ====== EMAIL LINK SIGN-IN FLOW ======

  $("sendLinkBtn").addEventListener("click", async () => {
    $("authMsg").textContent = "";
    const email = normEmail($("email").value);

    if (!email.endsWith("@" + COMPANY_DOMAIN)) {
      $("authMsg").innerHTML = `<span class="err">Use your @${escapeHtml(COMPANY_DOMAIN)} email.</span>`;
      return;
    }

    const actionCodeSettings = {
      url: window.location.href.split("#")[0], // current page
      handleCodeInApp: true
    };

    try {
      await sendSignInLinkToEmail(auth, email, actionCodeSettings);
      localStorage.setItem("emailForSignIn", email);
      $("authMsg").innerHTML = `<span class="ok">Link sent.</span> Check your email and open the link on this device.`;
    } catch (e) {
      $("authMsg").innerHTML = `<span class="err">${escapeHtml(e.message)}</span>`;
    }
  });

  // If this page is opened with the email sign-in link, complete sign-in
  (async function completeEmailLinkSignIn() {
    if (!isSignInWithEmailLink(auth, window.location.href)) return;

    let email = localStorage.getItem("emailForSignIn");
    if (!email) {
      // fallback prompt (simple)
      email = normEmail(prompt("Confirm your email to complete sign-in:") || "");
    }

    try {
      await signInWithEmailLink(auth, email, window.location.href);
      localStorage.removeItem("emailForSignIn");
      $("authMsg").innerHTML = `<span class="ok">Signed in.</span>`;
    } catch (e) {
      $("authMsg").innerHTML = `<span class="err">${escapeHtml(e.message)}</span>`;
    }
  })();

  $("logoutBtn").addEventListener("click", async () => {
    await signOut(auth);
  });

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      $("signedInMsg").textContent = "Not signed in.";
      setUI(false);
      return;
    }

    const profile = await ensureUserDoc(user);
    const myEmail = normEmail(user.email);
    const role = profile.role || "employee";
    const hod = role === "hod";

    $("signedInMsg").innerHTML = `<span class="ok">Signed in:</span> ${escapeHtml(myEmail)} (${escapeHtml(role)})`;
    setUI(true, hod);

    await loadPeersForMe(myEmail);
    await loadMyFeedback(myEmail);
    if (hod) await loadHodFeedback();

    // Buttons
    $("submitBtn").onclick = async () => {
      try {
        await submitFeedback(myEmail);
        $("submitMsg").innerHTML = `<span class="ok">Submitted.</span>`;
        $("rating").value = "";
        $("strength").value = "";
        $("improve").value = "";
        await loadMyFeedback(myEmail);
      } catch (e) {
        $("submitMsg").innerHTML = `<span class="err">${escapeHtml(e.message)}</span>`;
      }
    };

    $("refreshMine").onclick = () => loadMyFeedback(myEmail);
    $("refreshHod").onclick = () => loadHodFeedback();
  });
</script>
</body>
</html>
