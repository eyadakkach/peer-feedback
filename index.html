<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Peer Feedback — Survey</title>

  <style>
    :root{
      --bg:#f6f8fc;
      --text:#0f172a;
      --muted:#5b667a;
      --border:rgba(15,23,42,.10);
      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --primary:#2f6bff;
      --primary2:#2457d8;
      --danger:#d92d4b;
      --ok:#0f9d74;
      --chip: rgba(15,23,42,.06);
      --input: rgba(15,23,42,.04);
      --card: rgba(255,255,255,.92);
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(47,107,255,.12), transparent 60%),
        radial-gradient(800px 500px at 100% 0%, rgba(15,157,116,.10), transparent 50%),
        var(--bg);
    }

    .wrap{ max-width: 1200px; margin: 28px auto; padding: 0 14px 44px; }

    .topbar{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 12px;
      margin-bottom: 14px;
    }
    h1{ margin:0; font-size:22px; letter-spacing:.2px;}
    .sub{ margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.45; max-width: 900px; }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 8px 10px;
      border-radius: 999px;
      background: var(--chip);
      border: 1px solid var(--border);
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }
    .dot{ width:8px; height:8px; border-radius:999px; background: rgba(15,23,42,.25); }
    .dot.ok{ background: rgba(15,157,116,.9); }
    .dot.off{ background: rgba(217,45,75,.9); }

    .grid{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 16px;
    }

    .card h3{
      margin:0 0 12px;
      font-size: 15px;
      letter-spacing: .2px;
    }

    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    @media (max-width: 620px){
      .row{ grid-template-columns: 1fr; }
    }

    label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }

    input, select, textarea{
      width:100%;
      padding: 11px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: var(--input);
      color: var(--text);
      outline: none;
    }
    textarea{ min-height: 92px; resize: vertical; }
    select option{ color:#111; }
    select option:disabled{ color:#888; }

    .actions{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }

    .btn{
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 700;
      font-size: 13px;
      transition: transform .06s ease, box-shadow .15s ease;
    }
    .btn:hover{ transform: translateY(-1px); box-shadow: 0 8px 20px rgba(15,23,42,.08); }
    .btn:active{ transform: translateY(0px); }

    .btn.primary{
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      border-color: rgba(0,0,0,.05);
      color:#fff;
    }
    .btn.ghost{ background: transparent; }
    .btn.danger{
      background: rgba(217,45,75,.08);
      border-color: rgba(217,45,75,.25);
      color: var(--danger);
    }

    .msg{ margin-top: 10px; font-size: 13px; color: var(--muted); }
    .msg .ok{ color: var(--ok); font-weight: 800; }
    .msg .err{ color: var(--danger); font-weight: 800; }

    .divider{
      height:1px;
      background: rgba(15,23,42,.08);
      margin: 14px 0;
    }

    .scale{
      display:grid;
      gap:4px;
      font-size: 12px;
      color: var(--muted);
      background: rgba(15,23,42,.03);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      margin: 10px 0 14px;
    }

    .sectionTitle{
      margin: 14px 0 6px;
      font-weight: 900;
      font-size: 14px;
      letter-spacing: .15px;
    }
    .focus{
      margin: 0 0 10px;
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }

    .question{
      margin: 12px 0 6px;
      font-weight: 800;
      font-size: 13px;
    }

    .small{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
      margin: 6px 0 0;
    }

    details{
      border: 1px solid rgba(15,23,42,.10);
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(15,23,42,.02);
      margin-bottom: 10px;
    }
    summary{
      cursor:pointer;
      font-weight: 900;
      font-size: 13px;
      color: var(--text);
      display:flex;
      justify-content:space-between;
      gap: 10px;
      align-items:center;
    }
    .pill{
      display:inline-block;
      padding: 2px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(15,23,42,.03);
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
    }
    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 8px 12px;
      margin-top: 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .kv b{ color: var(--text); font-weight: 800; }

    .stickyRight .card{ position: sticky; top: 14px; }
    @media (max-width: 980px){
      .stickyRight .card{ position: static; }
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="topbar">
      <div>
        <h1>360° Feedback Survey</h1>
        <p class="sub">
          Rate assigned peers once. Recipients see feedback anonymously (no rater name). Admin reporting can use the private table.
        </p>
      </div>
      <div class="badge" id="statusBadge">
        <span class="dot off" id="statusDot"></span>
        <span id="statusText">Not logged in</span>
      </div>
    </div>

    <div class="grid">
      <!-- LEFT -->
      <div>
        <!-- LOGIN -->
        <div class="card" id="loginCard">
          <h3>Login</h3>
          <div class="row">
            <div>
              <label>Your company email</label>
              <input id="email" placeholder="name@company.com" autocomplete="email"/>
            </div>
            <div>
              <label>Your PIN</label>
              <input id="pin" type="password" placeholder="PIN" autocomplete="current-password"/>
            </div>
          </div>
          <div class="actions">
            <button class="btn primary" id="loginBtn" type="button">Login</button>
            <button class="btn ghost" id="logoutBtn" type="button" style="display:none;">Logout</button>
            <button class="btn ghost" id="refreshBtn" type="button" style="display:none;">Refresh</button>
          </div>
          <div id="loginMsg" class="msg"></div>
        </div>

        <!-- SURVEY -->
        <div class="card" id="surveyCard" style="display:none; margin-top:14px;">
          <h3>Give feedback</h3>

          <label>Recipient (your allowed peers)</label>
          <select id="recipient">
            <option value="">Loading…</option>
          </select>
          <div class="small" id="recipientHint"></div>

          <div class="scale">
            <div><strong>The Rating Scale</strong></div>
            <div>1 — Needs Significant Improvement (rarely demonstrates this behavior)</div>
            <div>3 — Competent (consistently demonstrates this behavior)</div>
            <div>5 — Role Model (exceptional; sets the standard for others)</div>
          </div>

          <!-- Communication -->
          <div class="sectionTitle">Communication</div>
          <div class="focus">Focus: Clarity, active listening, and information flow</div>

          <div class="focus">Does this person communicate their ideas and expectations clearly?</div>
          <select id="comm_clear"></select>

          <div class="focus">Do they actively listen to others without interrupting?</div>
          <select id="comm_listen"></select>

          <div class="focus">Are they effective at keeping the team updated on their progress and potential blockers?</div>
          <select id="comm_updates"></select>

          <div class="focus">Do they provide constructive and respectful feedback?</div>
          <select id="comm_feedback"></select>
          
          <div class="small"><b>Communication avg:</b> <span class="pill" id="avg_communication">—</span></div>

          <div class="divider"></div>

          <!-- Collaboration -->
          <div class="sectionTitle">Collaboration &amp; Teamwork</div>
          <div class="focus">Focus: Synergy, support, and conflict resolution</div>

          <div class="focus">Is this person approachable and willing to help other team members?</div>
          <select id="collab_help"></select>

          <div class="focus">Do they contribute positively to team discussions and brainstorming sessions?</div>
          <select id="collab_discuss"></select>

          <div class="focus">How well do they handle disagreements or conflicts within the team?</div>
          <select id="collab_conflict"></select>

          <div class="focus">Do they prioritize team goals over personal accolades?</div>
          <select id="collab_teamgoals"></select>

          <div class="small"><b>Collaboration avg:</b> <span class="pill" id="avg_collaboration">—</span></div>

          <div class="divider"></div>

          <!-- Reliability -->
          <div class="sectionTitle">Reliability &amp; Accountability</div>
          <div class="focus">Focus: Ownership, timeliness, and trust</div>

          <div class="focus">Can you rely on this person to deliver high-quality work on time?</div>
          <select id="rely_onTime"></select>

          <div class="focus">Do they take ownership of their mistakes rather than shifting blame?</div>
          <select id="rely_ownership"></select>

          <div class="focus">Do they follow through on commitments made during meetings?</div>
          <select id="rely_follow"></select>

          <div class="small"><b>Reliability avg:</b> <span class="pill" id="avg_reliability">—</span></div>

          <div class="divider"></div>

          <!-- Problem Solving -->
          <div class="sectionTitle">Problem Solving &amp; Quality of Work</div>
          <div class="focus">Focus: Critical thinking, standard of output, and innovation</div>

          <div class="focus">Does this person provide thorough and high-quality outputs?</div>
          <select id="ps_quality"></select>

          <div class="focus">Do they approach problems with a solution-oriented mindset?</div>
          <select id="ps_solution"></select>

          <div class="focus">Are they able to make sound decisions even when under pressure?</div>
          <select id="ps_pressure"></select>

          <div class="small"><b>Problem Solving avg:</b> <span class="pill" id="avg_problemSolving">—</span></div>

          <div class="divider"></div>

          <!-- Professionalism -->
          <div class="sectionTitle">Professionalism &amp; Integrity</div>
          <div class="focus">Focus: Emotional intelligence, workplace ethics, cultural sensitivity, and office dynamics</div>

          <div class="focus">Does this person treat everyone with equal respect, regardless of their seniority, background, or role?</div>
          <select id="prof_respect"></select>

          <div class="focus">When they disagree, do they do so with tact and sensitivity?</div>
          <select id="prof_tact"></select>

          <div class="focus">Does this person avoid office gossip, negativity, or back-channeling (undermining others behind their back)?</div>
          <select id="prof_gossip"></select>

          <div class="focus">Do they maintain a professional demeanor and emotional control during high-pressure situations?</div>
          <select id="prof_control"></select>

          <div class="focus">Is this person mindful of the diverse cultural backgrounds within the team in their communication style?</div>
          <select id="prof_culture"></select>

          <div class="small"><b>Professionalism avg:</b> <span class="pill" id="avg_professionalism">—</span></div>

          <div class="divider"></div>

          <!-- Strategic -->
          <div class="sectionTitle">Strategic Thinking &amp; Business Acumen</div>
          <div class="focus">Focus: Big picture, long-term vision, market awareness, and alignment with company goals</div>

          <div class="focus">Does this person understand how their specific tasks contribute to the wider team and company objectives?</div>
          <select id="strat_objectives"></select>

          <div class="focus">Do they anticipate future risks and opportunities, rather than just reacting to immediate problems?</div>
          <select id="strat_anticipate"></select>

          <div class="focus">Do they consider the cost, ROI, or resource implications of their decisions?</div>
          <select id="strat_roi"></select>

          <div class="focus">Are they able to distinguish between what is urgent and what is important for the long-term success of the project?</div>
          <select id="strat_urgent"></select>

          <div class="focus">Do they suggest improvements or new ideas that align with market trends or the company's strategic direction?</div>
          <select id="strat_trends"></select>

          <div class="small"><b>Strategic avg:</b> <span class="pill" id="avg_strategic">—</span></div>

          <div class="divider"></div>

          <!-- Qualitative -->
          <div class="sectionTitle">Qualitative Feedback (Open-Ended)</div>
          <div class="focus">Stop / Start / Continue</div>

          <div class="focus">Stop: What is one thing this person does that hinders the team's progress or morale?</div>
          <textarea id="q_stop" placeholder="Required…"></textarea>

          <div class="focus">Start: What is one thing this person should start doing to be more effective?</div>
          <textarea id="q_start" placeholder="Required…"></textarea>

          <div class="focus">Continue: What is this person’s “superpower” or greatest strength that they should keep utilizing?</div>
          <textarea id="q_continue" placeholder="Required…"></textarea>

          <div class="actions">
            <button class="btn primary" id="submitBtn" type="button">Submit</button>
          </div>
          <div id="submitMsg" class="msg"></div>
          <div class="small">Already-rated peers will be disabled after submission.</div>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="stickyRight">
        <div class="card" id="myFeedbackCard" style="display:none;">
          <h3>My feedback (anonymous)</h3>
          <div id="mine"></div>
          <div class="small">
            If you see “The query requires an index”, open the Firebase link shown and create the index once.
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, doc, getDoc,
    collection, query, where, getDocs,
    addDoc, serverTimestamp,
    orderBy, limit
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  /** ====== PASTE YOUR FIREBASE CONFIG HERE ====== */
const firebaseConfig = {
  apiKey: "AIzaSyCZxIgiXvpVIA10mbAfXdelZ2GAA8Zc5jQ",
  authDomain: "peer-feedback-4de63.firebaseapp.com",
  projectId: "peer-feedback-4de63",
  storageBucket: "peer-feedback-4de63.firebasestorage.app",
  messagingSenderId: "977480782634",
  appId: "1:977480782634:web:2bf3b786ca8ab3d8e4c453"
};


  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const $ = (id) => document.getElementById(id);

  function escapeHtml(s) {
    return String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  }
  function normEmail(email) { return String(email || "").trim().toLowerCase(); }
  function setStatus(loggedIn, email="") {
    const dot = $("statusDot");
    const text = $("statusText");
    if (loggedIn) {
      dot.classList.remove("off"); dot.classList.add("ok");
      text.textContent = email ? `Logged in: ${email}` : "Logged in";
    } else {
      dot.classList.remove("ok"); dot.classList.add("off");
      text.textContent = "Not logged in";
    }
  }

  /** ====== Session ====== */
  const KEY_EMAIL = "pf_email";
  function setSession(email) { localStorage.setItem(KEY_EMAIL, email); }
  function getSessionEmail() { return localStorage.getItem(KEY_EMAIL); }
  function clearSession() { localStorage.removeItem(KEY_EMAIL); }

  /** ====== 3-point scale ====== */
  const SCALE_OPTS = [
    { v: 1, label: "1 | Needs Significant Improvement" },
    { v: 2, label: "2 | Needs Improvement-Competent" },
    { v: 3, label: "3 | Competent" },
    { v: 4, label: "4 | Competent-Role Model" },
    { v: 5, label: "5 | Role Model" },
  ];

  function fillScaleSelect(selectId) {
    const sel = $(selectId);
    sel.innerHTML =
      `<option value="">Select…</option>` +
      SCALE_OPTS.map(o => `<option value="${o.v}">${escapeHtml(o.label)}</option>`).join("");
  }

  const SCALE_SELECT_IDS = [
    "comm_clear","comm_listen","comm_updates","comm_feedback",
    "collab_help","collab_discuss","collab_conflict","collab_teamgoals",
    "rely_onTime","rely_ownership","rely_follow",
    "ps_quality","ps_solution","ps_pressure",
    "prof_respect","prof_tact","prof_gossip","prof_control","prof_culture",
    "strat_objectives","strat_anticipate","strat_roi","strat_urgent","strat_trends"
  ];

  const QUESTION_TEXT = {
    communication: [
      ["comm_clear","Does this person communicate their ideas and expectations clearly?"],
      ["comm_listen","Do they actively listen to others without interrupting?"],
      ["comm_updates","Are they effective at keeping the team updated on their progress and potential blockers?"],
      ["comm_feedback","Do they provide constructive and respectful feedback?"],
    ],
    collaboration: [
      ["collab_help","Is this person approachable and willing to help other team members?"],
      ["collab_discuss","Do they contribute positively to team discussions and brainstorming sessions?"],
      ["collab_conflict","How well do they handle disagreements or conflicts within the team?"],
      ["collab_teamgoals","Do they prioritize team goals over personal accolades?"],
    ],
    reliability: [
      ["rely_onTime","Can you rely on this person to deliver high-quality work on time?"],
      ["rely_ownership","Do they take ownership of their mistakes rather than shifting blame?"],
      ["rely_follow","Do they follow through on commitments made during meetings?"],
    ],
    problemSolving: [
      ["ps_quality","Does this person provide thorough and high-quality outputs?"],
      ["ps_solution","Do they approach problems with a solution-oriented mindset?"],
      ["ps_pressure","Are they able to make sound decisions even when under pressure?"],
    ],
    professionalism: [
      ["prof_respect","Does this person treat everyone with equal respect, regardless of their seniority, background, or role?"],
      ["prof_tact","When they disagree, do they do so with tact and sensitivity?"],
      ["prof_gossip","Does this person avoid office gossip, negativity, or back-channeling (undermining others behind their back)?"],
      ["prof_control","Do they maintain a professional demeanor and emotional control during high-pressure situations?"],
      ["prof_culture","Is this person mindful of the diverse cultural backgrounds within the team in their communication style?"],
    ],
    strategic: [
      ["strat_objectives","Does this person understand how their specific tasks contribute to the wider team and company objectives?"],
      ["strat_anticipate","Do they anticipate future risks and opportunities, rather than just reacting to immediate problems?"],
      ["strat_roi","Do they consider the cost, ROI, or resource implications of their decisions?"],
      ["strat_urgent","Are they able to distinguish between what is urgent and what is important for the long-term success of the project?"],
      ["strat_trends","Do they suggest improvements or new ideas that align with market trends or the company's strategic direction?"],
    ],
  };

  function initScaleSelects() { SCALE_SELECT_IDS.forEach(fillScaleSelect); }

  function getSelectInt(id) {
    const v = parseInt(String($(id).value), 10);
    return Number.isFinite(v) ? v : null;
  }

  /** ====== PIN check ====== */
  async function checkPin(email, pin) {
    const ref = doc(db, "pins", email);
    const snap = await getDoc(ref);
    if (!snap.exists()) return { ok: false, error: "No PIN set for this email." };
    const data = snap.data();
    if (data.active === false) return { ok: false, error: "Account is disabled." };
    if (String(data.pin || "") !== String(pin || "")) return { ok: false, error: "Invalid PIN." };
    return { ok: true };
  }

  /** ====== One-time rated set + peers ====== */
  async function getAlreadyRatedSet(raterEmail) {
    const qy = query(collection(db, "feedback_private"), where("raterEmail", "==", raterEmail));
    const snap = await getDocs(qy);
    const set = new Set();
    snap.forEach(d => {
      const rec = normEmail(d.data().recipientEmail);
      if (rec) set.add(rec);
    });
    return set;
  }

  async function getPeersForRater(raterEmail) {
    const qy = query(collection(db, "peerMap"), where("raterEmail", "==", raterEmail));
    const snap = await getDocs(qy);
    return snap.docs.map(d => normEmail(d.data().peerEmail)).filter(Boolean);
  }

  /** ====== Load recipients and disable submitted ====== */
  async function loadRecipients(myEmail) {
    const [peers, ratedSet] = await Promise.all([
      getPeersForRater(myEmail),
      getAlreadyRatedSet(myEmail)
    ]);

    const sel = $("recipient");
    if (!peers.length) {
      sel.innerHTML = `<option value="">No peers assigned</option>`;
      $("recipientHint").textContent = "";
      return;
    }

    const options = peers.map(p => {
      const already = ratedSet.has(p);
      const label = already ? `${p} (submitted)` : p;
      return `<option value="${escapeHtml(p)}" ${already ? "disabled" : ""}>${escapeHtml(label)}</option>`;
    }).join("");

    sel.innerHTML = `<option value="">Select…</option>` + options;

    const left = peers.filter(p => !ratedSet.has(p)).length;
    $("recipientHint").textContent = left === 0
      ? "You have already submitted feedback for all assigned peers."
      : `${left} peer(s) available to rate. Submitted peers are disabled.`;
  }

  /** ====== Compute averages ====== */
  function computeAverages(scores) {
    const sectionAverages = {};
    const all = [];

    for (const [section, obj] of Object.entries(scores || {})) {
      const vals = Object.values(obj || {}).filter(v => Number.isFinite(v));
      const avg = vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : null;
      sectionAverages[section] = avg;
      all.push(...vals);
    }

    const overall = all.length ? all.reduce((a,b)=>a+b,0)/all.length : null;
    return { sectionAverages, overall };
  }

  /** ====== Render My Feedback (detailed first, then avg) ====== */
  function renderOneSubmission(r, idx) {
    const t = r.createdAt?.toDate ? r.createdAt.toDate().toLocaleString() : "";
    const { sectionAverages, overall } = computeAverages(r.scores || {});
    const overallTxt = overall ? overall.toFixed(2) : "—";

    const sections = [
      ["Communication","communication"],
      ["Collaboration & Teamwork","collaboration"],
      ["Reliability & Accountability","reliability"],
      ["Problem Solving & Quality of Work","problemSolving"],
      ["Professionalism & Integrity","professionalism"],
      ["Strategic Thinking & Business Acumen","strategic"],
    ];

    const sectionHtml = sections.map(([label, key]) => {
      const sec = r.scores?.[key] || {};
      const avg = sectionAverages[key];
      const avgTxt = avg ? avg.toFixed(2) : "—";

      const qs = (QUESTION_TEXT[key] || []).map(([id, qText]) => {
        const val = sec[id];
        return `
          <div class="kv">
            <div>${escapeHtml(qText)}</div>
            <div><b>${escapeHtml(val ?? "—")}</b></div>
          </div>
        `;
      }).join("");

      return `
        <div class="divider"></div>
        <div class="small"><b>${escapeHtml(label)} avg:</b> <span class="pill">${escapeHtml(avgTxt)}</span></div>
        ${qs}
      `;
    }).join("");

    const q = r.qualitative || {};
    const qualitative = `
      <div class="divider"></div>
      <div class="small"><b>Stop:</b> ${escapeHtml(q.stop || "—")}</div>
      <div class="small"><b>Start:</b> ${escapeHtml(q.start || "—")}</div>
      <div class="small"><b>Continue:</b> ${escapeHtml(q.continue || "—")}</div>
    `;

    return `
      <details ${idx === 0 ? "open" : ""}>
        <summary>
          <span>Submission • ${escapeHtml(t)}</span>
          <span class="pill">Overall avg: ${escapeHtml(overallTxt)}</span>
        </summary>
        ${sectionHtml}
        ${qualitative}
      </details>
    `;
  }

  function renderMine(rows) {
    if (!rows.length) return `<p class="small">No feedback found.</p>`;
    return rows.map((r, i) => renderOneSubmission(r, i)).join("");
  }

  async function loadMyFeedback(myEmail) {
    // recipientEmail + createdAt ordering may require composite index
    const qy = query(
      collection(db, "feedback_public"),
      where("recipientEmail", "==", myEmail),
      orderBy("createdAt", "desc"),
      limit(80)
    );
    const snap = await getDocs(qy);
    return snap.docs.map(d => d.data());
  }

  /** ====== Submit ====== */
  function collectScores() {
    return {
      communication: {
        comm_clear: getSelectInt("comm_clear"),
        comm_listen: getSelectInt("comm_listen"),
        comm_updates: getSelectInt("comm_updates"),
        comm_feedback: getSelectInt("comm_feedback"),
      },
      collaboration: {
        collab_help: getSelectInt("collab_help"),
        collab_discuss: getSelectInt("collab_discuss"),
        collab_conflict: getSelectInt("collab_conflict"),
        collab_teamgoals: getSelectInt("collab_teamgoals"),
      },
      reliability: {
        rely_onTime: getSelectInt("rely_onTime"),
        rely_ownership: getSelectInt("rely_ownership"),
        rely_follow: getSelectInt("rely_follow"),
      },
      problemSolving: {
        ps_quality: getSelectInt("ps_quality"),
        ps_solution: getSelectInt("ps_solution"),
        ps_pressure: getSelectInt("ps_pressure"),
      },
      professionalism: {
        prof_respect: getSelectInt("prof_respect"),
        prof_tact: getSelectInt("prof_tact"),
        prof_gossip: getSelectInt("prof_gossip"),
        prof_control: getSelectInt("prof_control"),
        prof_culture: getSelectInt("prof_culture"),
      },
      strategic: {
        strat_objectives: getSelectInt("strat_objectives"),
        strat_anticipate: getSelectInt("strat_anticipate"),
        strat_roi: getSelectInt("strat_roi"),
        strat_urgent: getSelectInt("strat_urgent"),
        strat_trends: getSelectInt("strat_trends"),
      }
    };
  }

  function validateScores(scores) {
    const all = [];
    for (const sec of Object.values(scores)) for (const v of Object.values(sec)) all.push(v);
    return all.every(v => Number.isFinite(v) && v >= 1 && v <= 5);
  }

  async function submitSurvey(myEmail) {
    const recipientEmail = normEmail($("recipient").value);
    if (!recipientEmail) throw new Error("Select a recipient.");
    if (recipientEmail === myEmail) throw new Error("You cannot rate yourself.");

    // mapping exists: doc id raterEmail__recipientEmail
    const mapId = `${myEmail}__${recipientEmail}`;
    const mapSnap = await getDoc(doc(db, "peerMap", mapId));
    if (!mapSnap.exists()) throw new Error("Not allowed to rate this peer (mapping missing).");

    // one-time
    const ratedSet = await getAlreadyRatedSet(myEmail);
    if (ratedSet.has(recipientEmail)) throw new Error("You already submitted feedback for this person.");

    const scores = collectScores();
    if (!validateScores(scores)) throw new Error("Please answer all rating questions (1–3).");

    const qualitative = {
      stop: $("q_stop").value.trim(),
      start: $("q_start").value.trim(),
      continue: $("q_continue").value.trim()
    };

    if (!qualitative.stop || !qualitative.start || !qualitative.continue) {
  throw new Error("Please fill Stop, Start, and Continue.");
}


    const payloadPublic = {
      recipientEmail,
      scores,
      qualitative,
      createdAt: serverTimestamp()
    };

    const payloadPrivate = {
      raterEmail: myEmail,
      recipientEmail,
      scores,
      qualitative,
      createdAt: serverTimestamp()
    };

    await addDoc(collection(db, "feedback_public"), payloadPublic);
    await addDoc(collection(db, "feedback_private"), payloadPrivate);
  }

  /** ====== UI Flow ====== */
  function setLoggedInUI(on) {
    $("logoutBtn").style.display = on ? "" : "none";
    $("refreshBtn").style.display = on ? "" : "none";
    $("surveyCard").style.display = on ? "" : "none";
    $("myFeedbackCard").style.display = on ? "" : "none";
  }

  async function refreshAll() {
    const email = getSessionEmail();
    if (!email) return;
    await loadRecipients(email);
    const mine = await loadMyFeedback(email);
    $("mine").innerHTML = renderMine(mine);
  }

  function resetForm() {
    $("recipient").value = "";
    SCALE_SELECT_IDS.forEach(id => { $(id).value = ""; });
    $("q_stop").value = "";
    $("q_start").value = "";
    $("q_continue").value = "";
  }

  $("loginBtn").addEventListener("click", async () => {
    $("loginMsg").innerHTML = "";
    try {
      const email = normEmail($("email").value);
      const pin = $("pin").value.trim();
      if (!email || !pin) throw new Error("Enter email and PIN.");

      const res = await checkPin(email, pin);
      if (!res.ok) throw new Error(res.error);

      setSession(email);
      setStatus(true, email);
      setLoggedInUI(true);
      $("loginMsg").innerHTML = `<span class="ok">OK.</span>`;

      initScaleSelects();
      await refreshAll();
    } catch (e) {
      $("loginMsg").innerHTML = `<span class="err">${escapeHtml(e.message)}</span>`;
      setStatus(false);
      setLoggedInUI(false);
    }
  });

  $("logoutBtn").addEventListener("click", () => {
    clearSession();
    setLoggedInUI(false);
    setStatus(false);
    $("loginMsg").textContent = "Logged out.";
    $("submitMsg").textContent = "";
    $("mine").innerHTML = "";
  });

  $("refreshBtn").addEventListener("click", refreshAll);

  $("submitBtn").addEventListener("click", async () => {
    $("submitMsg").innerHTML = "";
    try {
      const email = getSessionEmail();
      if (!email) throw new Error("Login first.");

      await submitSurvey(email);

      $("submitMsg").innerHTML = `<span class="ok">Submitted.</span>`;
      resetForm();
      await refreshAll();
    } catch (e) {
      $("submitMsg").innerHTML = `<span class="err">${escapeHtml(e.message)}</span>`;
    }
  });

  // Auto restore session
  (async function init() {
    initScaleSelects();
    const email = getSessionEmail();
    if (email) {
      setStatus(true, email);
      setLoggedInUI(true);
      $("loginMsg").innerHTML = `<span class="ok">Session restored.</span>`;
      await refreshAll();
    } else {
      setStatus(false);
      setLoggedInUI(false);
    }
  })();
</script>
</body>
</html>





