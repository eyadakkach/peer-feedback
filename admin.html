<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Peer Feedback — Admin Export</title>
  <style>
    :root{
      --bg:#f6f8fc;
      --text:#0f172a;
      --muted:#5b667a;
      --border:rgba(15,23,42,.12);
      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --primary:#2f6bff;
      --primary2:#2457d8;
      --danger:#d92d4b;
      --chip: rgba(15,23,42,.06);
      --input: rgba(15,23,42,.04);
      --card: rgba(255,255,255,.92);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(47,107,255,.12), transparent 60%),
        radial-gradient(800px 500px at 100% 0%, rgba(15,157,116,.10), transparent 50%),
        var(--bg);
    }
    .wrap{ max-width: 1400px; margin: 22px auto; padding: 0 14px 40px; }
    .top{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom: 12px; }
    h1{ margin:0; font-size:20px; }
    .sub{ margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.45; max-width: 980px; }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 14px;
    }
    .bar{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:end;
      margin-bottom: 12px;
    }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input{
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: var(--input);
      width: 260px;
      outline:none;
    }
    .btn{
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 800;
      font-size: 13px;
    }
    .btn.primary{
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      color:#fff;
      border-color: rgba(0,0,0,.06);
    }
    .btn.danger{
      background: rgba(217,45,75,.08);
      border-color: rgba(217,45,75,.25);
      color: var(--danger);
    }
    .msg{ margin-top: 8px; font-size: 13px; color: var(--muted); }
    .pill{
      display:inline-block;
      padding: 2px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(15,23,42,.03);
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
    }
    .tableWrap{
      overflow:auto;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: #fff;
    }
    table{
      width: max(1200px, 100%);
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td{
      border-bottom: 1px solid rgba(15,23,42,.08);
      padding: 8px 10px;
      vertical-align: top;
      white-space: nowrap;
    }
    th{
      position: sticky; top: 0;
      background: rgba(15,23,42,.03);
      color: var(--muted);
      font-weight: 900;
      text-align:left;
      z-index: 1;
    }
    td.long{
      white-space: normal;
      min-width: 320px;
      max-width: 560px;
    }
    .right{ text-align:right; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Admin Export (Excel-friendly)</h1>
        <p class="sub">
          This page shows all submissions from <span class="pill">feedback_private</span> as a flat table.
          Use <b>Copy TSV</b> to paste directly into Excel, or <b>Download CSV</b>.
          Scale is 1–3.
        </p>
      </div>
      <button class="btn danger" id="exitBtn" type="button">Exit admin</button>
    </div>

    <div class="card">
      <div class="bar">
        <div>
          <label>Filter recipient contains</label>
          <input id="fRecipient" placeholder="e.g. tala@" />
        </div>
        <div>
          <label>Filter rater contains</label>
          <input id="fRater" placeholder="e.g. mehmet@" />
        </div>
        <button class="btn" id="applyBtn" type="button">Apply filters</button>
        <button class="btn" id="clearBtn" type="button">Clear</button>

        <span style="flex:1"></span>

        <button class="btn" id="refreshBtn" type="button">Refresh</button>
        <button class="btn primary" id="copyTsvBtn" type="button">Copy TSV (Excel)</button>
        <button class="btn" id="downloadCsvBtn" type="button">Download CSV</button>
      </div>

      <div class="msg" id="msg"></div>

      <div class="tableWrap">
        <table id="tbl">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore, collection, query, orderBy, limit, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  /** ====== ADMIN GATE (optional) ======
   * If you do not care about any admin protection, delete this block.
   */
  const isAdmin = localStorage.getItem("pf_is_admin") === "true";
  if (!isAdmin) {
    // Change to your admin login page if you have one:
    window.location.href = "./admin-login.html";
  }

  /** ====== PASTE YOUR FIREBASE CONFIG HERE ====== */
const firebaseConfig = {
  apiKey: "AIzaSyCZxIgiXvpVIA10mbAfXdelZ2GAA8Zc5jQ",
  authDomain: "peer-feedback-4de63.firebaseapp.com",
  projectId: "peer-feedback-4de63",
  storageBucket: "peer-feedback-4de63.firebasestorage.app",
  messagingSenderId: "977480782634",
  appId: "1:977480782634:web:2bf3b786ca8ab3d8e4c453"
};


  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const $ = (id) => document.getElementById(id);

  const QUESTIONS = [
    // Communication
    { key:"comm_clear", section:"Communication", label:"Communicates ideas & expectations clearly" },
    { key:"comm_listen", section:"Communication", label:"Actively listens without interrupting" },
    { key:"comm_updates", section:"Communication", label:"Keeps team updated on progress & blockers" },
    { key:"comm_feedback", section:"Communication", label:"Constructive & respectful feedback" },

    // Collaboration
    { key:"collab_help", section:"Collaboration", label:"Approachable and helps others" },
    { key:"collab_discuss", section:"Collaboration", label:"Positive contribution to discussions" },
    { key:"collab_conflict", section:"Collaboration", label:"Handles disagreements/conflicts well" },
    { key:"collab_teamgoals", section:"Collaboration", label:"Team goals over personal accolades" },

    // Reliability
    { key:"rely_onTime", section:"Reliability", label:"Delivers high-quality work on time" },
    { key:"rely_ownership", section:"Reliability", label:"Owns mistakes (no blame shifting)" },
    { key:"rely_follow", section:"Reliability", label:"Follows through on commitments" },

    // Problem Solving
    { key:"ps_quality", section:"ProblemSolving", label:"Thorough and high-quality outputs" },
    { key:"ps_solution", section:"ProblemSolving", label:"Solution-oriented mindset" },
    { key:"ps_pressure", section:"ProblemSolving", label:"Sound decisions under pressure" },

    // Professionalism
    { key:"prof_respect", section:"Professionalism", label:"Equal respect regardless of role/background" },
    { key:"prof_tact", section:"Professionalism", label:"Disagrees with tact and sensitivity" },
    { key:"prof_gossip", section:"Professionalism", label:"Avoids gossip/negativity/back-channeling" },
    { key:"prof_control", section:"Professionalism", label:"Professional demeanor under pressure" },
    { key:"prof_culture", section:"Professionalism", label:"Mindful of cultural diversity in communication" },

    // Strategic
    { key:"strat_objectives", section:"Strategic", label:"Understands link to objectives" },
    { key:"strat_anticipate", section:"Strategic", label:"Anticipates risks and opportunities" },
    { key:"strat_roi", section:"Strategic", label:"Considers cost/ROI/resources" },
    { key:"strat_urgent", section:"Strategic", label:"Urgent vs important (long-term)" },
    { key:"strat_trends", section:"Strategic", label:"Suggests aligned improvements/ideas" },
  ];

  const SECTION_KEYS = [
    ["Communication","communication"],
    ["Collaboration","collaboration"],
    ["Reliability","reliability"],
    ["Problem Solving","problemSolving"],
    ["Professionalism","professionalism"],
    ["Strategic","strategic"],
  ];

  function norm(s){ return String(s||"").trim().toLowerCase(); }
  function safeNum(v){
    const n = parseInt(String(v), 10);
    return Number.isFinite(n) ? n : "";
  }
  function formatDate(createdAt){
    try{
      if (createdAt?.toDate) return createdAt.toDate().toISOString();
    }catch(e){}
    return "";
  }

  function computeAverages(scores){
    const sectionAverages = {};
    const all = [];

    for (const [section, obj] of Object.entries(scores || {})) {
      const vals = Object.values(obj || {}).filter(v => Number.isFinite(v));
      const avg = vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : null;
      sectionAverages[section] = avg;
      all.push(...vals);
    }

    const overall = all.length ? all.reduce((a,b)=>a+b,0)/all.length : null;
    return { sectionAverages, overall };
  }

  // Columns in the exact order we want for Excel
  const COLS = [
    { key:"createdAt", label:"createdAt (ISO)" },
    { key:"raterEmail", label:"raterEmail" },
    { key:"recipientEmail", label:"recipientEmail" },

    // Section averages
    { key:"avg_communication", label:"avg Communication" },
    { key:"avg_collaboration", label:"avg Collaboration" },
    { key:"avg_reliability", label:"avg Reliability" },
    { key:"avg_problemSolving", label:"avg Problem Solving" },
    { key:"avg_professionalism", label:"avg Professionalism" },
    { key:"avg_strategic", label:"avg Strategic" },
    { key:"avg_overall", label:"avg Overall" },

    // Each question score (1..3)
    ...QUESTIONS.map(q => ({ key:q.key, label:`${q.section} — ${q.label}` })),

    // Qualitative
    { key:"stop", label:"Stop" },
    { key:"start", label:"Start" },
    { key:"continue", label:"Continue" },
  ];

  let rawRows = [];      // raw from Firestore
  let flatRows = [];     // flattened objects for table/export

  function flattenOne(doc){
    const scores = doc.scores || {};
    const q = doc.qualitative || {};
    const { sectionAverages, overall } = computeAverages(scores);

    const out = {
      createdAt: formatDate(doc.createdAt),
      raterEmail: doc.raterEmail || "",
      recipientEmail: doc.recipientEmail || "",
      avg_communication: sectionAverages.communication ? sectionAverages.communication.toFixed(2) : "",
      avg_collaboration: sectionAverages.collaboration ? sectionAverages.collaboration.toFixed(2) : "",
      avg_reliability: sectionAverages.reliability ? sectionAverages.reliability.toFixed(2) : "",
      avg_problemSolving: sectionAverages.problemSolving ? sectionAverages.problemSolving.toFixed(2) : "",
      avg_professionalism: sectionAverages.professionalism ? sectionAverages.professionalism.toFixed(2) : "",
      avg_strategic: sectionAverages.strategic ? sectionAverages.strategic.toFixed(2) : "",
      avg_overall: overall ? overall.toFixed(2) : "",
      stop: q.stop || "",
      start: q.start || "",
      continue: q.continue || "",
    };

    // Pull each score (if missing, blank)
    for (const qq of QUESTIONS){
      // Identify which section object holds the key
      // (we stored as scores.communication.comm_clear etc)
      let val = "";
      for (const [, sectionKey] of SECTION_KEYS){
        if (scores?.[sectionKey] && Object.prototype.hasOwnProperty.call(scores[sectionKey], qq.key)){
          val = safeNum(scores[sectionKey][qq.key]);
          break;
        }
      }
      out[qq.key] = val;
    }

    return out;
  }

  function buildHeader(){
    $("thead").innerHTML = `
      <tr>
        ${COLS.map(c => `<th>${escapeHtml(c.label)}</th>`).join("")}
      </tr>
    `;
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  }

  function renderTable(rows){
    $("tbody").innerHTML = rows.map(r => {
      return `<tr>${
        COLS.map(c => {
          const v = r[c.key] ?? "";
          const cls = (c.key === "stop" || c.key === "start" || c.key === "continue") ? "long" : "";
          const align = String(c.key).startsWith("avg_") ? "right" : "";
          return `<td class="${cls} ${align}">${escapeHtml(v)}</td>`;
        }).join("")
      }</tr>`;
    }).join("");
  }

  function applyFilters(){
    const fr = norm($("fRater").value);
    const fp = norm($("fRecipient").value);

    const rows = flatRows.filter(r => {
      const okR = fr ? norm(r.raterEmail).includes(fr) : true;
      const okP = fp ? norm(r.recipientEmail).includes(fp) : true;
      return okR && okP;
    });

    renderTable(rows);
    $("msg").innerHTML = `Showing <b>${rows.length}</b> row(s).`;
    return rows;
  }

  function toTSV(rows){
    const header = COLS.map(c => c.label).join("\t");
    const lines = rows.map(r => COLS.map(c => String(r[c.key] ?? "").replace(/\r?\n/g, " ")).join("\t"));
    return [header, ...lines].join("\n");
  }

  function toCSV(rows){
    const esc = (s) => {
      const v = String(s ?? "").replace(/\r?\n/g, " ");
      if (/[",\n]/.test(v)) return `"${v.replace(/"/g,'""')}"`;
      return v;
    };
    const header = COLS.map(c => esc(c.label)).join(",");
    const lines = rows.map(r => COLS.map(c => esc(r[c.key])).join(","));
    return [header, ...lines].join("\n");
  }

  async function refresh(){
    $("msg").textContent = "Loading…";
    buildHeader();

    const qy = query(collection(db, "feedback_private"), orderBy("createdAt", "desc"), limit(1000));
    const snap = await getDocs(qy);
    rawRows = snap.docs.map(d => d.data());
    flatRows = rawRows.map(flattenOne);

    const shown = applyFilters();
    $("msg").innerHTML = `Loaded <b>${flatRows.length}</b> total row(s). Showing <b>${shown.length}</b>.`;
  }

  $("applyBtn").addEventListener("click", applyFilters);
  $("clearBtn").addEventListener("click", () => {
    $("fRater").value = "";
    $("fRecipient").value = "";
    applyFilters();
  });

  $("refreshBtn").addEventListener("click", refresh);

  $("copyTsvBtn").addEventListener("click", async () => {
    const shown = applyFilters();
    const text = toTSV(shown);
    await navigator.clipboard.writeText(text);
    $("msg").innerHTML = `Copied <b>${shown.length}</b> row(s) as TSV. Paste directly into Excel.`;
  });

  $("downloadCsvBtn").addEventListener("click", () => {
    const shown = applyFilters();
    const csv = toCSV(shown);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `peer_feedback_export_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(url);
    $("msg").innerHTML = `Downloaded CSV for <b>${shown.length}</b> row(s).`;
  });

  $("exitBtn").addEventListener("click", () => {
    localStorage.removeItem("pf_is_admin");
    window.location.href = "./admin-login.html";
  });

  await refresh();
</script>
</body>
</html>
