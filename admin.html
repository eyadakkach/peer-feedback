<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Peer Feedback — Admin Export</title>
  <style>
    :root{
      --bg:#f6f8fc;
      --text:#0f172a;
      --muted:#5b667a;
      --border:rgba(15,23,42,.12);
      --shadow: 0 10px 30px rgba(15,23,42,.08);
      --primary:#2f6bff;
      --primary2:#2457d8;
      --danger:#d92d4b;
      --ok:#0f9d74;
      --chip: rgba(15,23,42,.06);
      --input: rgba(15,23,42,.04);
      --card: rgba(255,255,255,.92);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(47,107,255,.12), transparent 60%),
        radial-gradient(800px 500px at 100% 0%, rgba(15,157,116,.10), transparent 50%),
        var(--bg);
    }
    .wrap{ max-width: 1600px; margin: 22px auto; padding: 0 14px 40px; }
    .top{ display:flex; align-items:flex-start; justify-content:space-between; gap:12px; margin-bottom: 12px; }
    h1{ margin:0; font-size:20px; }
    .sub{ margin:6px 0 0; color:var(--muted); font-size:13px; line-height:1.45; max-width: 1100px; }

    .card{
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      padding: 14px;
    }

    .grid{
      display:grid;
      grid-template-columns: 420px 1fr;
      gap: 12px;
      align-items:start;
    }
    @media (max-width: 1100px){
      .grid{ grid-template-columns: 1fr; }
    }

    .sectionTitle{
      margin: 10px 0 8px;
      font-weight: 900;
      font-size: 13px;
      color: var(--text);
      letter-spacing: .2px;
    }

    .bar{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:end;
      margin-bottom: 12px;
    }
    label{ display:block; font-size:12px; color:var(--muted); margin-bottom:6px; }
    input, select{
      padding:10px 12px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: var(--input);
      width: 100%;
      outline:none;
    }

    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }

    .btn{
      border: 1px solid var(--border);
      background: #fff;
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      font-weight: 800;
      font-size: 13px;
    }
    .btn.primary{
      background: linear-gradient(180deg, var(--primary), var(--primary2));
      color:#fff;
      border-color: rgba(0,0,0,.06);
    }
    .btn.danger{
      background: rgba(217,45,75,.08);
      border-color: rgba(217,45,75,.25);
      color: var(--danger);
    }
    .btn.ghost{
      background: transparent;
    }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }

    .msg{ margin-top: 8px; font-size: 13px; color: var(--muted); }
    .msg .ok{ color: var(--ok); font-weight: 900; }
    .msg .err{ color: var(--danger); font-weight: 900; }

    .pill{
      display:inline-block;
      padding: 2px 8px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(15,23,42,.03);
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
    }

    .divider{
      height:1px;
      background: rgba(15,23,42,.10);
      margin: 12px 0;
    }

    .tableWrap{
      overflow:auto;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: #fff;
    }
    table{
      width: max(1400px, 100%);
      border-collapse: collapse;
      font-size: 12px;
    }
    th, td{
      border-bottom: 1px solid rgba(15,23,42,.08);
      padding: 8px 10px;
      vertical-align: top;
      white-space: nowrap;
    }
    th{
      position: sticky; top: 0;
      background: rgba(15,23,42,.03);
      color: var(--muted);
      font-weight: 900;
      text-align:left;
      z-index: 1;
    }
    td.long{
      white-space: normal;
      min-width: 320px;
      max-width: 560px;
    }
    .right{ text-align:right; }

    .hint{
      font-size: 12px;
      color: var(--muted);
      line-height: 1.4;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>Admin Export (Excel-friendly)</h1>
        <p class="sub">
          This page reads from <span class="pill">feedback_private</span> and shows a flat table (one row per submission).
          Use <b>Copy TSV</b> to paste directly into Excel, or <b>Download CSV</b>.
          Scale is 1–3. Mapping (who can rate who) is managed here via <span class="pill">peerMap</span>.
        </p>
      </div>
      <button class="btn danger" id="exitBtn" type="button">Exit admin</button>
    </div>

    <div class="grid">
      <!-- LEFT: Controls -->
      <div class="card">
        <div class="sectionTitle">Admin controls</div>
        <div class="hint">
          Mapping doc id format: <span class="pill">raterEmail__peerEmail</span> (lowercased).
        </div>

        <div class="divider"></div>

        <div class="sectionTitle">Create / Update Relation (who can rate who)</div>
        <label>Rater email</label>
        <input id="mapRater" placeholder="mehmet@company.com"/>

        <label>Peer email (recipient)</label>
        <input id="mapPeer" placeholder="tala@company.com"/>

        <div class="actions">
          <button class="btn primary" id="saveMapBtn" type="button">Save relation</button>
        </div>
        <div class="msg" id="mapMsg"></div>

        <div class="divider"></div>

        <div class="sectionTitle">Create / Update User PIN</div>
        <label>User email</label>
        <input id="pinEmail" placeholder="mehmet@company.com"/>

        <div class="row2">
          <div>
            <label>PIN</label>
            <input id="pinValue" placeholder="e.g. 1357"/>
          </div>
          <div>
            <label>Active</label>
            <select id="pinActive">
              <option value="true">true</option>
              <option value="false">false</option>
            </select>
          </div>
        </div>

        <div class="actions">
          <button class="btn" id="savePinBtn" type="button">Save PIN</button>
        </div>
        <div class="msg" id="pinMsg"></div>

        <div class="divider"></div>

        <div class="sectionTitle">Export controls</div>

        <label>Filter recipient contains</label>
        <input id="fRecipient" placeholder="e.g. tala@" />

        <label>Filter rater contains</label>
        <input id="fRater" placeholder="e.g. mehmet@" />

        <div class="actions">
          <button class="btn" id="applyBtn" type="button">Apply filters</button>
          <button class="btn ghost" id="clearBtn" type="button">Clear</button>
        </div>

        <div class="actions">
          <button class="btn" id="refreshBtn" type="button">Refresh</button>
          <button class="btn primary" id="copyTsvBtn" type="button">Copy TSV (Excel)</button>
          <button class="btn" id="downloadCsvBtn" type="button">Download CSV</button>
        </div>

        <div class="msg" id="msg"></div>
      </div>

      <!-- RIGHT: Table -->
      <div class="card">
        <div class="sectionTitle">All submissions (private)</div>
        <div class="tableWrap">
          <table id="tbl">
            <thead id="thead"></thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getFirestore,
    doc, setDoc,
    collection, query, orderBy, limit, getDocs
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  /** ====== ADMIN GATE (optional) ======
   * If you do not care about any admin protection, delete this block.
   */
  const isAdmin = localStorage.getItem("pf_is_admin") === "true";
  if (!isAdmin) {
    window.location.href = "./admin-login.html";
  }

  /** ====== PASTE YOUR FIREBASE CONFIG HERE ====== */
const firebaseConfig = {
  apiKey: "AIzaSyCZxIgiXvpVIA10mbAfXdelZ2GAA8Zc5jQ",
  authDomain: "peer-feedback-4de63.firebaseapp.com",
  projectId: "peer-feedback-4de63",
  storageBucket: "peer-feedback-4de63.firebasestorage.app",
  messagingSenderId: "977480782634",
  appId: "1:977480782634:web:2bf3b786ca8ab3d8e4c453"
};


  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const $ = (id) => document.getElementById(id);

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, c => ({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[c]));
  }
  function norm(s){ return String(s || "").trim().toLowerCase(); }

  function formatDate(createdAt){
    try{
      if (createdAt?.toDate) return createdAt.toDate().toISOString();
    }catch(e){}
    return "";
  }

  function computeAverages(scores){
    const sectionAverages = {};
    const all = [];

    for (const [section, obj] of Object.entries(scores || {})) {
      const vals = Object.values(obj || {}).filter(v => Number.isFinite(v));
      const avg = vals.length ? vals.reduce((a,b)=>a+b,0)/vals.length : null;
      sectionAverages[section] = avg;
      all.push(...vals);
    }

    const overall = all.length ? all.reduce((a,b)=>a+b,0)/all.length : null;
    return { sectionAverages, overall };
  }

  /** ====== Authoritative mapping: section -> questions ====== */
  const QUESTION_MAP = {
    communication: [
      ["comm_clear","Communicates ideas & expectations clearly"],
      ["comm_listen","Actively listens without interrupting"],
      ["comm_updates","Keeps team updated on progress & blockers"],
      ["comm_feedback","Constructive & respectful feedback"],
    ],
    collaboration: [
      ["collab_help","Approachable and helps others"],
      ["collab_discuss","Positive contribution to discussions"],
      ["collab_conflict","Handles disagreements/conflicts well"],
      ["collab_teamgoals","Team goals over personal accolades"],
    ],
    reliability: [
      ["rely_onTime","Delivers high-quality work on time"],
      ["rely_ownership","Owns mistakes (no blame shifting)"],
      ["rely_follow","Follows through on commitments"],
    ],
    problemSolving: [
      ["ps_quality","Thorough and high-quality outputs"],
      ["ps_solution","Solution-oriented mindset"],
      ["ps_pressure","Sound decisions under pressure"],
    ],
    professionalism: [
      ["prof_respect","Equal respect regardless of role/background"],
      ["prof_tact","Disagrees with tact and sensitivity"],
      ["prof_gossip","Avoids gossip/negativity/back-channeling"],
      ["prof_control","Professional demeanor under pressure"],
      ["prof_culture","Mindful of cultural diversity"],
    ],
    strategic: [
      ["strat_objectives","Understands link to objectives"],
      ["strat_anticipate","Anticipates risks and opportunities"],
      ["strat_roi","Considers cost/ROI/resources"],
      ["strat_urgent","Urgent vs important (long-term)"],
      ["strat_trends","Suggests aligned improvements/ideas"],
    ]
  };

  /** ====== Build question columns from mapping ====== */
  const QUESTION_COLS = [];
  for (const [sectionKey, arr] of Object.entries(QUESTION_MAP)){
    for (const [qid, label] of arr){
      QUESTION_COLS.push({ key: qid, label: `${sectionKey} — ${label}` });
    }
  }

  /** ====== Columns in Excel order ====== */
  const COLS = [
    { key:"createdAt", label:"createdAt (ISO)" },
    { key:"raterEmail", label:"raterEmail" },
    { key:"recipientEmail", label:"recipientEmail" },

    { key:"avg_communication", label:"avg Communication" },
    { key:"avg_collaboration", label:"avg Collaboration" },
    { key:"avg_reliability", label:"avg Reliability" },
    { key:"avg_problemSolving", label:"avg Problem Solving" },
    { key:"avg_professionalism", label:"avg Professionalism" },
    { key:"avg_strategic", label:"avg Strategic" },
    { key:"avg_overall", label:"avg Overall" },

    ...QUESTION_COLS,

    { key:"stop", label:"Stop" },
    { key:"start", label:"Start" },
    { key:"continue", label:"Continue" },
  ];

  let flatRows = [];

  function buildHeader(){
    $("thead").innerHTML = `
      <tr>
        ${COLS.map(c => `<th>${escapeHtml(c.label)}</th>`).join("")}
      </tr>
    `;
  }

  function flattenOne(docData){
    const scores = docData.scores || {};
    const q = docData.qualitative || {};
    const { sectionAverages, overall } = computeAverages(scores);

    const out = {
      createdAt: formatDate(docData.createdAt),
      raterEmail: docData.raterEmail || "",
      recipientEmail: docData.recipientEmail || "",

      avg_communication: sectionAverages.communication ? sectionAverages.communication.toFixed(2) : "",
      avg_collaboration: sectionAverages.collaboration ? sectionAverages.collaboration.toFixed(2) : "",
      avg_reliability: sectionAverages.reliability ? sectionAverages.reliability.toFixed(2) : "",
      avg_problemSolving: sectionAverages.problemSolving ? sectionAverages.problemSolving.toFixed(2) : "",
      avg_professionalism: sectionAverages.professionalism ? sectionAverages.professionalism.toFixed(2) : "",
      avg_strategic: sectionAverages.strategic ? sectionAverages.strategic.toFixed(2) : "",
      avg_overall: overall ? overall.toFixed(2) : "",

      stop: q.stop || "",
      start: q.start || "",
      continue: q.continue || ""
    };

    // Deterministic extraction: section -> question key
    for (const [sectionKey, arr] of Object.entries(QUESTION_MAP)) {
      for (const [qid] of arr) {
        out[qid] = (scores && scores[sectionKey] && (scores[sectionKey][qid] ?? "")) ?? "";
      }
    }

    return out;
  }

  function renderTable(rows){
    $("tbody").innerHTML = rows.map(r => {
      return `<tr>${
        COLS.map(c => {
          const v = r[c.key] ?? "";
          const long = (c.key === "stop" || c.key === "start" || c.key === "continue") ? "long" : "";
          const right = String(c.key).startsWith("avg_") ? "right" : "";
          return `<td class="${long} ${right}">${escapeHtml(v)}</td>`;
        }).join("")
      }</tr>`;
    }).join("");
  }

  function applyFilters(){
    const fr = norm($("fRater").value);
    const fp = norm($("fRecipient").value);

    const rows = flatRows.filter(r => {
      const okR = fr ? norm(r.raterEmail).includes(fr) : true;
      const okP = fp ? norm(r.recipientEmail).includes(fp) : true;
      return okR && okP;
    });

    renderTable(rows);
    $("msg").innerHTML = `Showing <b>${rows.length}</b> row(s).`;
    return rows;
  }

  function toTSV(rows){
    const header = COLS.map(c => c.label).join("\t");
    const lines = rows.map(r =>
      COLS.map(c => String(r[c.key] ?? "").replace(/\r?\n/g, " ")).join("\t")
    );
    return [header, ...lines].join("\n");
  }

  function toCSV(rows){
    const esc = (s) => {
      const v = String(s ?? "").replace(/\r?\n/g, " ");
      if (/[",\n]/.test(v)) return `"${v.replace(/"/g,'""')}"`;
      return v;
    };
    const header = COLS.map(c => esc(c.label)).join(",");
    const lines = rows.map(r => COLS.map(c => esc(r[c.key])).join(","));
    return [header, ...lines].join("\n");
  }

  async function refresh(){
    $("msg").textContent = "Loading…";
    buildHeader();

    const qy = query(collection(db, "feedback_private"), orderBy("createdAt", "desc"), limit(1500));
    const snap = await getDocs(qy);

    flatRows = snap.docs.map(d => flattenOne(d.data()));
    const shown = applyFilters();

    $("msg").innerHTML = `Loaded <b>${flatRows.length}</b> total row(s). Showing <b>${shown.length}</b>.`;
  }

  /** ====== Admin mapping (relation) ====== */
  $("saveMapBtn").addEventListener("click", async () => {
    $("mapMsg").innerHTML = "";
    try{
      const raterEmail = norm($("mapRater").value);
      const peerEmail = norm($("mapPeer").value);
      if (!raterEmail || !peerEmail) throw new Error("Enter both emails.");

      const id = `${raterEmail}__${peerEmail}`;
      await setDoc(doc(db, "peerMap", id), { raterEmail, peerEmail });

      $("mapMsg").innerHTML = `<span class="ok">Saved:</span> <span class="pill">${escapeHtml(id)}</span>`;
    }catch(e){
      $("mapMsg").innerHTML = `<span class="err">${escapeHtml(e.message)}</span>`;
    }
  });

  /** ====== Admin user PINs ====== */
  $("savePinBtn").addEventListener("click", async () => {
    $("pinMsg").innerHTML = "";
    try{
      const email = norm($("pinEmail").value);
      const pin = String($("pinValue").value || "").trim();
      const active = $("pinActive").value === "true";
      if (!email || !pin) throw new Error("Enter email and PIN.");

      await setDoc(doc(db, "pins", email), { pin, active });

      $("pinMsg").innerHTML = `<span class="ok">Saved PIN for:</span> <span class="pill">${escapeHtml(email)}</span>`;
    }catch(e){
      $("pinMsg").innerHTML = `<span class="err">${escapeHtml(e.message)}</span>`;
    }
  });

  /** ====== Export actions ====== */
  $("applyBtn").addEventListener("click", applyFilters);
  $("clearBtn").addEventListener("click", () => {
    $("fRater").value = "";
    $("fRecipient").value = "";
    applyFilters();
  });
  $("refreshBtn").addEventListener("click", refresh);

  $("copyTsvBtn").addEventListener("click", async () => {
    const shown = applyFilters();
    const text = toTSV(shown);
    await navigator.clipboard.writeText(text);
    $("msg").innerHTML = `Copied <b>${shown.length}</b> row(s) as TSV. Paste directly into Excel.`;
  });

  $("downloadCsvBtn").addEventListener("click", () => {
    const shown = applyFilters();
    const csv = toCSV(shown);
    const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
    const url = URL.createObjectURL(blob);

    const a = document.createElement("a");
    a.href = url;
    a.download = `peer_feedback_export_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();

    URL.revokeObjectURL(url);
    $("msg").innerHTML = `Downloaded CSV for <b>${shown.length}</b> row(s).`;
  });

  $("exitBtn").addEventListener("click", () => {
    localStorage.removeItem("pf_is_admin");
    window.location.href = "./admin-login.html";
  });

  await refresh();
</script>
</body>
</html>
